# GUARDRAILS.md

> Persona Workshop / Persona Builder Web 的统一护栏文档（产品 / 安全 / 合规 / 质量 / 性能 / 发布）

## 0) 护栏目标
- 保证：可持续迭代、可回滚、可解释、可发布。
- 避免：越做越乱、功能堆叠导致失控、性能劣化、合规风险。

---

## 1) 产品与体验护栏

### 1.1 流程边界
- Quick 与 Deep 保持双轨：
  - Quick = 低门槛、即用型
  - Deep = 主语/动因/边界深构建
- 不强制串联：用户可只用 Quick。

### 1.2 输出体验
- 结果默认在页面内联展示（不使用大弹窗覆盖编辑流）。
- 反馈统一使用轻量 toast。

### 1.3 文案一致性
- 顶层核心语义统一：`我是什么（单选）`
- 未选核心统一：`未选择核心`
- 术语表统一维护（中英一一对应，避免同义混乱）。

---

## 2) 架构与代码护栏

### 2.1 版本纪律（必须）
- 每次对外可见改动都更新：
  - `VERSION`
  - `CHANGELOG.md`
- 存在可执行回滚说明：`ROLLBACK.md`

### 2.2 结构纪律
- 核心层（engine）与风格碎片层（stack）必须解耦。
- 模板和碎片文案不得散落多个文件硬编码；统一集中管理。
- 数据 schema 变更必须写迁移说明（localStorage key 变更要兼容旧值）。

### 2.3 变更边界
- 功能改动优先小步提交（一次只改一类问题）。
- 引入新依赖前先回答：不用它是否可实现？


### 2.4 Prompt 输出质量护栏（新增）
- 碎片叠加不得产生语义冲突（尤其是 engine 后缀与 stack 风格冲突）。
- 新增碎片或修改 `ENGINE_SUFFIXES` 时，必须至少做 2 组「engine × stacks」交叉检查。
- 发现自相矛盾输出时，视为阻断级问题，不进入主分支。

### 2.5 引擎/碎片注册纪律（新增）
- 新增 engine 必须同时注册：
  - 模板映射（`TEMPLATES_*`）
  - 引擎后缀映射（`ENGINE_SUFFIXES`）
- 缺任一注册项，视为未完成，不进入主分支。
- 新增 stack（`STACKS_*`）时，需检查与已有 stack 在同字段（value/style/stance/modules/ease/brake）叠加后是否冲突。

### 2.6 localStorage 容量边界（新增）
- 单个 key 的 value 建议不超过 100KB。
- 总占用建议不超过 2MB（保守值，跨浏览器更稳）。
- 接近阈值时：优先清理最旧 handoff 缓存，再提示用户。
- 若写入失败，不得静默；必须提示并给清理指引。

---

## 3) i18n 护栏

### 3.1 覆盖要求
- 所有用户可见文本必须可切换语言：
  - 标题/按钮/标签/placeholder/toast/错误提示/回填提示/模板文案

### 3.2 机制要求
- 页面文本使用 `data-i18n`
- placeholder 使用 `data-i18n-ph`
- 统一语言键：`pb_lang`
- 语言切换后需触发动态区域重渲染（如 combo bar、反馈文本）

### 3.3 质量要求
- 禁止“中英混搭句”作为最终态（除品牌词、专有名词）。
- 双语语义必须对齐，不做“字面翻译导致语气错位”。

---

## 4) 安全与合规护栏

### 4.1 风险动作边界
涉及以下操作必须二次确认：
- 账号/隐私/金钱/不可逆动作

### 4.2 内容边界
- 高风险、违法、真实危害导向内容：拒绝并给安全替代。
- AI 生成内容需提示：非绝对事实，建议人工复核。

### 4.3 数据边界
- 默认本地优先；若上云需明示采集范围与用途。
- 提供用户可见的数据清除入口。

### 4.4 发布必备文档（App 前）
- Privacy Policy
- Terms of Service
- 数据删除机制说明

---

## 5) 性能护栏（长期不卡核心）

> 阶段说明：以下性能指标在 **v1.0 前** 作为参考与观察项，不作为阻断发布的硬门槛；在 **v1.0 后** 升级为发版前置条件。

### 5.1 预算护栏（发版门槛）
- LCP < 2.5s（移动端）
- INP < 200ms
- 页面主线程长任务（>50ms）数量可控
- 任一指标明显退化则暂停发布

### 5.2 交互护栏
- 输入联动逻辑必须 debounce（建议 120~200ms）
- 重计算优先放在“点击生成”而非每次键入
- 用户操作必须即时反馈（loading/toast）

### 5.3 资源护栏
- 图片压缩（webp/avif）+ 按尺寸投放
- 避免不必要第三方脚本和重库
- 非关键资源延迟加载

### 5.4 渲染护栏
- 动画优先 `transform/opacity`
- 避免频繁强制回流（reflow）

### 5.5 回归护栏
- 每次上线前跑 Lighthouse（桌面 + 移动）
- 记录性能基线，连续两次退化必须排查

---

## 6) 发布与回滚护栏

### 6.1 发布前 Checklist（最小）
- 功能回归：Quick/Deep、copy、handoff、语言切换
- i18n 回归：中英全流程检查
- 性能回归：v1.0 前记录 Lighthouse 趋势；v1.0 后要求达标
- 文档回归：VERSION/CHANGELOG 更新

### 6.2 回滚策略
- 若线上出现严重问题：
  1) 立即回滚到上一个稳定版本
  2) 记录故障范围与根因
  3) 修复后再发，不热修堆补丁

---

## 7) App 导向护栏（路线一致性）

### 7.1 路线
- 先 PWA 验证
- 再 Capacitor 壳化（iOS/Android）
- 规模增长后再评估原生重构

### 7.2 API 护栏（Deep LLM）
- 接口最小化：`POST /api/deep/generate`
- 必须有：超时、重试、限流、降级到本地规则

---

## 8) 执行规则（强制）
- 新功能若违反任意护栏，不进入主分支。
- 护栏本身可演进，但必须记录变更原因与时间。
- 护栏优先级高于“临时方便”。

---

## 9) 维护节奏
- 每周一次：检查护栏执行情况（5-10 分钟）
- 每两周一次：删掉失效规则，补上新风险
- 每个里程碑结束：更新本文件并在 CHANGELOG 记一笔
